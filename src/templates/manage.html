{% extends "maintemplate.html" %}

{% block title %}Manage{% endblock %}

{% block style %}

<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/jquery-ui-1.10.2.custom.min.css') }}" />

<style type="text/css">
	a.alert-link {
		color: #dd5600;
		cursor: pointer;
	}
	
	a.alert-link:hover {
		color: #dd5600;
	}
</style>

{% endblock %}

{% block script %}

<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-ui-1.10.2.custom.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.tablesorter.min.js') }}"></script>

<script type="text/javascript">
	
	var lastRemoveGuestID;
	var lastRemoveLink;
	
	function hide_undo_message() {
		$("#undoMessage").hide();
		return false;
	}
	
	function checkIn(guestID, firstName, lastName, button) {
	// Check in item user is lending
		$.ajax({
			url: "/checkin/" + guestID,
			type: 'GET',
			success: function(data) {
				$(button).parent().parent().hide();
				$("#undoMessage").show();
				$("#undoMessageName").text(firstName + ' ' + lastName);
				lastRemoveGuestID = guestID;
				lastRemoveLink = button; // Gor some reason nothing is coming through. It worked in managelibrary.html
				if($("#guestQueue tr:visible").length == 1) {
					$("#guestQueue").html("<tr><td colspan='4'>There are no guests in the queue. Once guests have signed in, they'll show up here.</td></tr>");
				}
			}
		});
		
		return false;
	}
	
	function hide_undo_message() {
		$("#undoMessage").hide();
		return false;
	}
	
	function undo_checkin() {
		$.post("/undo_checkin/" + lastRemoveGuestID, function(data) {
			$(lastRemoveLink).parent().parent().show();
			$("#undoMessage").hide();
		})
		return false;
	}
	
	function sendDefaultMsg(guestID, button) {
	
	}
	
	function customMsgModal(guestID, firstName, lastName, button) {
		var msg = "{{ cur_user.default_msg_ready }}";
		var msg = msg.replace("{firstName}",firstName);
		var msg = msg.replace("{lastName}",lastName);
		$("#customMsgModalText").text(msg);
		$("#customMsgModal").modal('show');
		// Add guestID to onClick for send button (for calling sendCustomMsg)
	}
	
	function sendCustomMsg(guestID, button) {
		msg = $("#customMsgModalText").text();
	}
	
</script>

{% endblock %}

{% block content %}

<br>

<div class="row">
	
</div>

<div class="row" style="position: relative">
	<div class="span6 offset3" style="position: absolute;">
		<div id="undoMessage" class="alert" style="display: none;">
			<a class="close" onclick="hide_undo_message()">&times;</a>
			<span id="undoMessageName"></span> has been checked in.&nbsp;&nbsp;
			<strong><a onclick="undo_checkin()" class="alert-link">Undo</a></strong>
		</div>
	</div>
	
	<div id="customMsgModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="customMsgModalLabel" aria-hidden="true">
	  <div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3 id="customMsgModalLabel">Send Custom Message</h3>
	  </div>
	  <div class="modal-body">
		<textarea id="customMsgModalText" rows="3" style="width:516px"></textarea>
	  </div>
	  <div class="modal-footer">
		<button class="btn btn-primary" dat-dismiss="modal" area-hidden="true" onClick="sendCustomMsg">Send</button>
		<button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
	  </div>
	</div>
	
  <div class="span12">
	
          <h3 style="margin-top:-4px">Manage Queue</h3>
          <table class="table table-striped table-bordered" id="guestQueue">
            {% if guestlist|length < 1 %}
              <tr>
                <td colspan="4">There are no guests in the queue. Once guests have signed in, they'll show up here.</td>
            {% else %}
				<tr>
				  <th class="header">Name</th>
				  <th class="header">Contact</th>
				  <th class="header">Check-in Time</th>
				  <th class="header" style="width:340px">Actions</th>
				</tr>
				{% for guest in guestlist %}
				  <tr>
					<td>{{guest.first_name}} {{guest.last_name}}</td>
					<td>{% if guest.sms_number %}{{guest.sms_number}}{% endif %}{% if guest.email%}{{guest.email}}{% endif %}</td>
					<td>{{guest.last_checkin}}</td>
					<td style="text-align:center">
						<a class="btn btn-primary btn-small" onclick="sendDefaultMsg('{{guest.key.id()}}',this)">
							<!--<i class="icon-mobile-phone"></i>&nbsp;&nbsp;-->Send Reminder
						</a>
						<a class="btn btn-info btn-small" onclick="customMsgModal('{{guest.key.id()}}','{{guest.first_name}}','{{guest.last_name}}',this)">
							Custom Reminder
						</a>
						<a class="btn btn-success btn-small" onclick="checkIn('{{guest.key.id()}}','{{guest.first_name}}','{{guest.last_name}}',this)">
							<i class="icon-ok"></i>&nbsp;&nbsp;Check In
						</a>
					</td>
				  </tr>
				{% endfor %}
			{% endif %}
          </table>
	</div>
    
</div>

{% endblock %}
